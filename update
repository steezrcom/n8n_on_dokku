#!/bin/bash
set -eo pipefail
trap "exit" INT

# Pull upstream changes
echo -e "\033[0;32m====>\033[0m Pull origin..."
git pull

echo -e "\033[0;32m====>\033[0m Initial check..."

# Get current release name
CURRENT_RELEASE=$(git tag --sort=version:refname | tail -1)


# Get the highest stable release name (exclude pre-release versions like -exp, -rc, etc.)
RELEASE=$(curl -s https://api.github.com/repos/n8n-io/n8n/releases?per_page=100 \
  | jq -r '.[] | select(.prerelease == false) | .tag_name' \
  | sed 's/n8n@//g; s/\"//g' \
  | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' \
  | sort -V \
  | tail -1)

# Exit script if already up to date
if [ "$RELEASE" = "$CURRENT_RELEASE" ]; then
  echo -e "\033[0;32m=>\033[0m Already up to date..."
  exit 0
fi

# Replace "from" line in dockerfile with the new release
sed -i "s#ARG N8N_VERSION.*#ARG N8N_VERSION=\"${RELEASE}\"#" Dockerfile

# Replace README link to n8n release
N8N_BADGE="[![n8n](https://img.shields.io/badge/n8n-${RELEASE}-blue.svg)](https://github.com/n8n-io/n8n/releases/tag/n8n%40${RELEASE})"
sed -i "s#\[\!\[n8n\].*#${N8N_BADGE}#" README.md

# Push changes
git add Dockerfile README.md
git commit -m "Update to n8n version ${RELEASE}"
git push origin master

# Create tag
git tag $RELEASE
git push --tags
